#!/usr/bin/env ruby

#
# digital normalisation using ruby cm-sketch
#

require 'mytest/mytest.so'
require 'trollop'

opts = Trollop::options do
  banner <<-EOS

Diginorm v0.2 by Chris Boursnell <cmb211@cam.ac.uk>

Digital Normalisation by median
Totally ripped off from Titus Brown (http://khmer.readthedocs.org/en/v1.1/)

USAGE:
diginorm <options>

OPTIONS:

EOS
  opt :left,
      "Comma separated list of fastq files (left)",
      :required => true,
      :type => String

  opt :right,
      "Comma separated list of fastq files (right)",
      :required => true,
      :type => String

  opt :k,
      "size of kmers to use",
      :default => 21,
      :type => :int

  opt :buckets,
      "number of buckets",
      :default => 4,
      :type => :int

  opt :bucket_size,
      "size of buckets",
      :short => 's',
      :type => :int

  opt :memory,
      "memory in gigabytes",
      :short => 'm',
      :type => :float

  opt :cutoff,
      "cutoff coverage",
      :default => 20,
      :type => :int

end

if !opts.memory and !opts.bucket_size
  Trollop::die "Must set either memory usage or bucket size"
end

Trollop::die "Cutoff must be less than 255" if opts.cutoff >= 255

if opts.bucket_size
  memory = opts.bucket_size * opts.buckets
  bucket_size = opts.bucket_size
elsif opts.memory
  bucket_size = (1e9*opts.memory/opts.buckets).to_i
  memory = (1e9*opts.memory).to_i
end

puts "memory = #{memory}"
puts "bucket_size = #{bucket_size}"

cms = MyTest.new(opts.k, bucket_size, opts.buckets, opts.cutoff)

input = opts.left.split(",").zip(opts.right.split(","))

input.each do |pair|
  unless File.exist?("#{pair[0]}")
    raise IOError.new("File not found: #{pair[0]}")
  end
  unless File.exist?("#{pair[1]}")
    raise IOError.new("File not found: #{pair[1]}")
  end
  if File.exist?("#{pair[0]}.out")
    raise IOError.new("Output already exists: #{pair[0]}.out")
  end
  if File.exist?("#{pair[1]}.out")
    raise IOError.new("Output already exists: #{pair[1]}.out")
  end
end

input.each do |pair|
  cms.run(pair[0], pair[1]) # call to c
end